<html>

<head>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-82810278-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-82810278-2');
    </script>
    <noscript>
        Should probably try with JavaScript on...
    </noscript>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Additional Highcharts javascript config -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="//cdn.ons.gov.uk/sixteens/cb6733a/css/main.css">
    <link href="https://cdn.ons.gov.uk/sixteens/658deeb/css/work-in-progress.css" rel="stylesheet" type="text/css">
    <script src="getListBulletins.js"></script>
    <style>
        table {
            width: 95%;
            padding: 2px;
        }

        .a {
            /* min-width: 10px; */
            width: 45%;

            padding-right: 2px;
            padding-left: 2px;
            /* max-width: 20px; */
        }

        .b {
            /* min-width: 10px; */
            width: 25%;
            padding-right: 2px;
            padding-left: 2px;

            /* max-width: 20px; */
        }
        th {
            padding-right: 2px;
            padding-left: 2px; 
        }
    </style>
</head>

<body class="pl-home">
    <div id="hide">
        <header>
            <a class="skiplink" href="#main" tabindex="0">
                Skip to main content
            </a>
        </header>

        <div class="page-intro background--astral padding-top-md--4">
            <div class="pl-wrap__inner padding-top-sm--4">
                <div class="wrapper">
                    <h1 class="page-intro__title page-intro__title--home-big padding-bottom-md--4">Publishing metrics</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="background--gallery padding-top-md--4 padding-bottom--3">

        <div class="wrapper">
            <h3>Get word count history for a bulletin</h3>
            <p class="padding-left--1">
                <select class="js-example-basic-single" style="width:50%" id="listOfBulletins" onchange="getBulletinWordCountHistory()">
                </select>
            </p>
            <div id="chart"></div>
        </div>
    </div>
    <div class="wrapper">
        <table id="releases">
            <tr>
                <th>Release</th>
                <th>Publication date</th>
                <th>Pubs</th>
                <th>Data</th>
                <th>Methods</th>
            </tr>
        </table>
    </div>

</body>

<script>
    function countReleases() {
        fetch(
            "https://www.ons.gov.uk/releasecalendar/data", {
                mode: "cors"
            }).then((data) => data.json()).then(function (data) {
                console.log(data.result.paginator.end)

            for (i=1; i < data.result.paginator.numberOfPages+1; i++) {

                console.log (i)
              fetch(
            "https://www.ons.gov.uk/releasecalendar/data?&size=500+&page=" + i, {
                mode: "cors"
            }).then((data) => data.json()).then(function (data) {  

            let datasets = []
            data.result.results.map(function (data) {
                fetch(domain + data.uri + "/data", {
                    mode: "cors"
                }).then((data) => data.json()).then(function (data) {
                    // console.log(data)
                    datasets = data.relatedDatasets.length
                    publications = data.relatedDocuments.length
                    methodology = data.relatedMethodology.length + data.relatedMethodologyArticle
                        .length
                    date = new Date(data.description.releaseDate).toUTCString()

                    tr = createNode("tr");
                    tr.innerHTML = "<td class= 'a'>" + data.description.title +
                        "</td><td class= 'b'>" + date + "</td><td>" + publications +
                        "</td><td>" + datasets + "</td><td>" + methodology + "</td>"
                    append(releases, tr);

                })

            })
        })
    }
        })
    }
</script>

<script>
    let timeseries = []

    function createNode(element) {
        return document.createElement(element);
    }

    function append(parent, el) {
        return parent.appendChild(el);
    }

    function sortlist() {
        let lb = document.getElementById('listOfBulletins');
        let options = document.getElementById('listOfBulletins');
        let n_options = options.length;
        let temp = []

        for (i = n_options; i--;) {
            temp[i] = options[i].text + ";" + options[i].value;
        }
        temp.sort();
        for (i = n_options; i--;) {
            parts = temp[i].split(';');
            options[i].text = parts[0];
            options[i].value = parts[1];
        }
    }


    function orderByDate(a, b) {
        if (a[2] < b[2]) return -1;
        if (a[2] > b[2]) return 1;
        return 0;
    }

    document.addEventListener("DOMContentLoaded", function () {
        getListBulletins()
        countReleases()
    })

    const domain = "https://www.ons.gov.uk"
</script>

</html>