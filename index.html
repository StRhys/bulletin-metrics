<html>

<head>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-82810278-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-82810278-2');
    </script>
    <noscript>
        Should probably try with JavaScript on...
    </noscript>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Additional Highcharts javascript config -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="//cdn.ons.gov.uk/sixteens/cb6733a/css/main.css">
    <link href="https://cdn.ons.gov.uk/sixteens/658deeb/css/work-in-progress.css" rel="stylesheet" type="text/css">
    <script src="getListBulletins.js"></script>
</head>

<body class="pl-home">
    <div id="hide">
        <header>
            <a class="skiplink" href="#main" tabindex="0">
                Skip to main content
            </a>
        </header>

        <div class="page-intro background--astral padding-top-md--4">
            <div class="pl-wrap__inner padding-top-sm--4">
                <div class="wrapper">
                    <h1 class="page-intro__title page-intro__title--home-big padding-bottom-md--4">Publishing metrics</h1>  
                </div>
            </div>
        </div>
    </div>

    <div class="background--gallery padding-top-md--4 padding-bottom-md--3">
        <div class="wrapper">
            <h3>Get word count history for a bulletin</h3>
            <p class="padding-left--1">
                <select class="js-example-basic-single" style="width:50%" id="listOfBulletins" onchange="getBulletinWordCountHistory()">
                </select>
            </p>
            <div id = "chart"></div>
        </div>
    </div>





</body>





<script>
    let timeseries = []
    function getBulletinWordCountHistory(value) {
        timeseries = []
        // document.getElementById("hidden").style.display = ""
        let selectedBulletin = document.getElementById("listOfBulletins");
        let parts = selectedBulletin.value.split('/');
        let lastSegment = parts.pop() || parts.pop();  // handle potential trailing slash
        selectedBulletin = selectedBulletin.value.split(lastSegment)[0];
        fetch (domain + selectedBulletin + "previousReleases/data?size=250", {mode: "cors"}).then((data) => data.json()).then(function (data) {
            // console.log(data)
            
            data.result.results.map(function (data) {
                fetch (domain + data.uri + "/data", {mode: "cors"}).then((data) => data.json()).then(function (data) {

                    // console.log (data)
                    wordCount(data)
                    
                    timeseries = timeseries.sort(orderByDate);
                    Highcharts.chart('chart', {
                series: [{
                    //add the data to the chart
                    data: timeseries,
                }],
                navigation: {
                    buttonOptions: {
                        enabled: false
                    }
                },
                title: {
                    text: null
                },
                yAxis: {
                    labels: {
                        enabled: false
                    },
                    title: {
                        enabled: false
                    },
                    min : 0
                },
                legend: {
                    enabled: false
                },
                plotOptions: {
                    series: {
                        color: '#3B7A9E'
                    }
                },
                xAxis: {
                    type: "category",
                    crosshair: true,
                }
            });

                })

            })


        })

    }



    function wordCount(data) {
        // console.log (data)
    // fetch (domain + data + "/data", {mode: "cors"}).then((data) => data.json()).then(function (data) {
        let bulletinData = data;
        let sections = data.sections.length;
        let totalWords = 0;
        for  (var i = 0; i < sections; i++){
        bulletinWords = bulletinData.sections[i].markdown.split(" ").length;
        totalWords = totalWords + bulletinWords
        // console.log(totalWords)
        releaseDate = data.description.releaseDate


        }
        let chartdata = [data.description.edition, parseFloat(totalWords),releaseDate]
            //add these arrays to the timeseries array
            timeseries.push(chartdata)
            return;
    // });
}

</script>

<script>
    function sortlist() {
        let lb = document.getElementById('listOfBulletins');
        let options = document.getElementById('listOfBulletins');
        let n_options = options.length;
        let temp = []

        for (i = n_options; i--;) {
            temp[i] = options[i].text + ";" + options[i].value;
        }
        temp.sort();
        for (i = n_options; i--;) {
            parts = temp[i].split(';');
            options[i].text = parts[0];
            options[i].value = parts[1];
        }
    }


    function orderByDate(a, b) {
        if (a[2] < b[2]) return -1;
        if (a[2] > b[2]) return 1;
        return 0;
    }

    document.addEventListener("DOMContentLoaded", function () {
        getListBulletins()
    })

    const domain = "https://www.ons.gov.uk"
</script>

</html>